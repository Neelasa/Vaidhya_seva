package Doctor.dao;

import Doctor.bean.LeaveBean;
import javax.swing.*;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class ReporterDao {

    private static final String DB_URL = "jdbc:mysql://localhost:3306/vaidhya_seva";
    private static final String USER = "root";
    private static final String PASS = "HAREKRISHNA";

    public Connection getCon() {
        Connection con = null;
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            con = DriverManager.getConnection(DB_URL, USER, PASS);
        } catch (Exception e) {
            JOptionPane.showMessageDialog(null, "Database connection error: " + e.getMessage());
            e.printStackTrace();
        }
        return con;
    }

    public void handleReporterOperations() {
        String[] options = {"Check Doctor Leave", "View All Doctor Leaves", "Back"};
        int choice;

        while (true) {
            choice = JOptionPane.showOptionDialog(
                    null,
                    "Choose an operation:",
                    "Reporter Panel",
                    JOptionPane.DEFAULT_OPTION,
                    JOptionPane.INFORMATION_MESSAGE,
                    null,
                    options,
                    options[0]);

            switch (choice) {
                case 0:
                    checkDoctorLeave();
                    break;
                case 1:
                    viewAllDoctorLeaves();
                    break;
                case 2:
                case JOptionPane.CLOSED_OPTION:
                    return;
                default:
                    JOptionPane.showMessageDialog(null, "Invalid choice. Please try again.");
            }
        }
    }

    private void checkDoctorLeave() {
        String doctorId = JOptionPane.showInputDialog("Enter Doctor ID to check leave status:");
        if (doctorId == null || doctorId.trim().isEmpty()) {
            return;
        }

        String sql = "SELECT * FROM leave WHERE doctorID = ? AND CURDATE() BETWEEN leaveFrom AND leaveTo AND status = 1";
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {
            con = getCon();
            if (con == null) return;
            ps = con.prepareStatement(sql);
            ps.setString(1, doctorId);
            rs = ps.executeQuery();

            if (rs.next()) {
                JOptionPane.showMessageDialog(null, "Doctor " + doctorId + " is on leave today.");
            } else {
                JOptionPane.showMessageDialog(null, "Doctor " + doctorId + " is available today.");
            }

        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Database error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            closeResources(con, ps, rs);
        }
    }

    private void viewAllDoctorLeaves() {
        String sql = "SELECT * FROM leave WHERE status = 1";
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {
            con = getCon();
            if (con == null) return;
            ps = con.prepareStatement(sql);
            rs = ps.executeQuery();

            StringBuilder leaveList = new StringBuilder("Active Leaves:\n\n");
            boolean found = false;
            while (rs.next()) {
                found = true;
                leaveList.append("Leave ID: ").append(rs.getString("leaveID")).append("\n");
                leaveList.append("Doctor ID: ").append(rs.getString("doctorID")).append("\n");
                leaveList.append("From: ").append(rs.getString("leaveFrom")).append("\n");
                leaveList.append("To: ").append(rs.getString("leaveTo")).append("\n");
                leaveList.append("Reason: ").append(rs.getString("reason")).append("\n");
                leaveList.append("----------------------------\n");
            }
            if (!found) {
                JOptionPane.showMessageDialog(null, "No active doctor leaves found.");
            } else {
                JOptionPane.showMessageDialog(null, leaveList.toString(), "All Doctor Leaves", JOptionPane.INFORMATION_MESSAGE);
            }

        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Database error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            closeResources(con, ps, rs);
        }
    }

    private void closeResources(Connection con, PreparedStatement ps, ResultSet rs) {
        try {
            if (rs != null) rs.close();
            if (ps != null) ps.close();
            if (con != null) con.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}