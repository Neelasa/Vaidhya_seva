package Doctor.dao;

import java.sql.*;
import javax.swing.JOptionPane;
import Doctor.bean.PatientBean;

public class PatientDao {

    private static Connection con;
    private static PreparedStatement ps;
    private static ResultSet rs;

    // Establish connection
    public static Connection getCon() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            return DriverManager.getConnection("jdbc:mysql://localhost:3306/vasavi", "root", "HAREKRISHNA");
        } catch (Exception e) {
            JOptionPane.showMessageDialog(null, "Connection Error: " + e.getMessage());
            return null;
        }
    }

    // ðŸ”„ Optional switch-case controller (for future use)
    public static void handlePatientOperations() {
        Connection conn = getCon();
        if (conn == null) return;

        while (true) {
            String[] options = {"Check Patient", "Back"};
            int choice = JOptionPane.showOptionDialog(null, "Choose an operation", "Patient Management",
                    JOptionPane.DEFAULT_OPTION, JOptionPane.INFORMATION_MESSAGE, null, options, options[0]);

            switch (choice) {
                case 0 -> {
                    String patientId = JOptionPane.showInputDialog("Enter Patient ID:");
                    PatientBean pb = checkPatient(conn, patientId);
                    if (pb.getPatientID() != null) {
                        StringBuilder sb = new StringBuilder();
                        sb.append("Patient Details:\n");
                        sb.append("User ID: ").append(pb.getUserID()).append("\n");
                        sb.append("Appointment Date: ").append(pb.getAppointmentDate()).append("\n");
                        sb.append("Ailment Type: ").append(pb.getAilmentType()).append("\n");
                        sb.append("Ailment Details: ").append(pb.getAilmentDetails()).append("\n");
                        sb.append("Diagnosis History: ").append(pb.getDiagnosisHistory()).append("\n");
                        JOptionPane.showMessageDialog(null, sb.toString());
                    } else {
                        JOptionPane.showMessageDialog(null, "No patient found with ID: " + patientId);
                    }
                }
                case 1 -> {
                    try { conn.close(); } catch (Exception ignored) {}
                    return;
                }
                default -> JOptionPane.showMessageDialog(null, "Invalid choice");
            }
        }
    }

    // âœ… Fetch patient details by ID
    public static PatientBean checkPatient(Connection conn, String patientId) {
        PatientBean pb = new PatientBean();

        try {
            String query = "SELECT * FROM Patient WHERE PatientId = ?";
            ps = conn.prepareStatement(query);
            ps.setString(1, patientId);
            rs = ps.executeQuery();

            if (rs.next()) {
                pb.setPatientID(rs.getString("PatientId"));
                pb.setUserID(rs.getString("UserId"));
                pb.setAppointmentDate(rs.getString("Appointment_Date"));
                pb.setAilmentType(rs.getString("Ailment_Type"));
                pb.setAilmentDetails(rs.getString("Ailment_Details"));
                pb.setDiagnosisHistory(rs.getString("Diagnosis_History"));
            }
        } catch (SQLException sql) {
            JOptionPane.showMessageDialog(null, "SQL Error: " + sql.getMessage());
        } finally {
            try {
                if (rs != null) rs.close();
                if (ps != null) ps.close();
            } catch (SQLException e) {
                JOptionPane.showMessageDialog(null, "Error closing resources: " + e.getMessage());
            }
        }

        return pb;
    }
}