package Doctor.dao;

import java.sql.*;
import javax.swing.JOptionPane;
import Doctor.bean.PatientBean;

public class PatientDao 
{

    private static Connection con;
    private static PreparedStatement ps;
    private static ResultSet rs;

    // Establish connection
    public static Connection getCon() 
    {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            return DriverManager.getConnection("jdbc:mysql://localhost:3306/vaidhya_seva", "root", "HAREKRISHNA");
        } catch (Exception e) {
            JOptionPane.showMessageDialog(null, "Connection Error: " + e.getMessage());
            return null;
        }
    }

    // Switch-case controller with Insert, View, Delete
    public static void handlePatientOperations() 
    {
        Connection conn = getCon();
        if (conn == null)	
        	{
        		return;
        	}

        while (true) 
        {
            String[] options = {"Insert Patient", "Check Patient", "Delete Patient", "Back/Return"};
            int ch = JOptionPane.showOptionDialog(null, "Choose an operation", "Patient Management",
                    JOptionPane.DEFAULT_OPTION, JOptionPane.INFORMATION_MESSAGE, null, options, options[0]);

            switch (ch )
            {
                case 0 -> insertPatient(conn);
                case 1 -> {
                    String patientId = JOptionPane.showInputDialog("Enter Patient ID:");
                    PatientBean pb = checkPatient(conn, patientId);
                    if (pb.getPatientID() != null) {
                        StringBuilder sb = new StringBuilder();
                        sb.append("Patient Details:\n");
                        sb.append("User ID: ").append(pb.getUserID()).append("\n");
                        sb.append("Appointment Date: ").append(pb.getAppointmentDate()).append("\n");
                        sb.append("Ailment Type: ").append(pb.getAilmentType()).append("\n");
                        sb.append("Ailment Details: ").append(pb.getAilmentDetails()).append("\n");
                        sb.append("Diagnosis History: ").append(pb.getDiagnosisHistory()).append("\n");
                        JOptionPane.showMessageDialog(null, sb.toString());
                    } else {
                        JOptionPane.showMessageDialog(null, "No patient found with ID: " + patientId);
                    }
                }
                case 2 -> deletePatient(conn);
                case 3 -> {
                    try { conn.close(); } catch (Exception ignored) {}
                    return;
                }
                default -> JOptionPane.showMessageDialog(null, "Invalid choice");
            }
        }
    }

    // Insert patient details
    public static void insertPatient(Connection conn) {
        try {
            String patientId = JOptionPane.showInputDialog("Enter Patient ID:");
            String userId = JOptionPane.showInputDialog("Enter User ID:");
            String appointmentDate = JOptionPane.showInputDialog("Enter Appointment Date (YYYY-MM-DD):");
            String ailmentType = JOptionPane.showInputDialog("Enter Ailment Type:");
            String ailmentDetails = JOptionPane.showInputDialog("Enter Ailment Details:");
            String diagnosisHistory = JOptionPane.showInputDialog("Enter Diagnosis History:");

            String sql = "INSERT INTO Patient (PatientId, UserId, Appointment_Date, Ailment_Type, Ailment_Details, Diagnosis_History) VALUES (?, ?, ?, ?, ?, ?)";
            ps = conn.prepareStatement(sql);
            ps.setString(1, patientId);
            ps.setString(2, userId);
            ps.setString(3, appointmentDate);
            ps.setString(4, ailmentType);
            ps.setString(5, ailmentDetails);
            ps.setString(6, diagnosisHistory);
            ps.executeUpdate();

            JOptionPane.showMessageDialog(null, "Patient inserted successfully.");
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Insert Error: " + e.getMessage());
        } finally {
            try {
                if (ps != null) ps.close();
            } catch (SQLException e) {
                JOptionPane.showMessageDialog(null, "Error closing statement: " + e.getMessage());
            }
        }
    }

    // Fetch patient details by ID
    public static PatientBean checkPatient(Connection conn, String patientId) {
        PatientBean pb = new PatientBean();

        try {
            String query = "SELECT * FROM Patient WHERE PatientId = ?";
            ps = conn.prepareStatement(query);
            ps.setString(1, patientId);
            rs = ps.executeQuery();

            if (rs.next()) {
                pb.setPatientID(rs.getString("PatientId"));
                pb.setUserID(rs.getString("UserId"));
                pb.setAppointmentDate(rs.getString("Appointment_Date"));
                pb.setAilmentType(rs.getString("Ailment_Type"));
                pb.setAilmentDetails(rs.getString("Ailment_Details"));
                pb.setDiagnosisHistory(rs.getString("Diagnosis_History"));
            }
        } catch (SQLException sql) {
            JOptionPane.showMessageDialog(null, "SQL Error: " + sql.getMessage());
        } finally {
            try {
                if (rs != null) rs.close();
                if (ps != null) ps.close();
            } catch (SQLException e) {
                JOptionPane.showMessageDialog(null, "Error closing resources: " + e.getMessage());
            }
        }

        return pb;
    }

    // Delete patient by ID
    public static void deletePatient(Connection conn) {
        try {
            String patientId = JOptionPane.showInputDialog("Enter Patient ID to delete:");
            String sql = "DELETE FROM Patient WHERE PatientId = ?";
            ps = conn.prepareStatement(sql);
            ps.setString(1, patientId);
            int rows = ps.executeUpdate();

            if (rows > 0) {
                JOptionPane.showMessageDialog(null, "Patient record deleted successfully.");
            } else {
                JOptionPane.showMessageDialog(null, "No patient found with ID: " + patientId);
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Delete Error: " + e.getMessage());
        } finally {
            try {
                if (ps != null) ps.close();
            } catch (SQLException e) {
                JOptionPane.showMessageDialog(null, "Error closing statement: " + e.getMessage());
            }
        }
    }
}